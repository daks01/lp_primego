---
import StarTrekText from "../ui/StarTrekText.astro";
import Button from "../ui/Button.astro";
---
<!-- 
	ToDo сделать отправку типа такой
	https://rameezimdad.blogspot.com/2023/09/conatct-form-data-to-google-sheet-and.html 
-->
<div data-animate>
	<StarTrekText as="h2" class="h1 title" id="form-title">
		Связаться с нами
	</StarTrekText>
	<p class="subtitle" id="form-subtitle">
		Мы можем вам помочь с&nbsp;выбором модели <br />
		и&nbsp;оформлением заказа
	</p>
	<form action="/order.php" data-contact-form class="form" aria-labelledby="form-title" aria-describedby="form-subtitle" novalidate>
		<div class="form__layout">
			<div class="form__row form__row_half">
				<label for="form-name" class="sr-only">Имя</label>
				<input id="form-name" type="text" placeholder="Имя" class="form-field" required/>
				<span class="form-field__error" data-field-error></span>
			</div>
			<div class="form__row form__row_half">
				<label for="form-name" class="sr-only">Почта</label>
				<input id="form-email" type="email" placeholder="Почта" class="form-field" required/>
				<span class="form-field__error" data-field-error></span>
			</div>
			<div class="form__row">
				<label for="form-question" class="sr-only">Текст сообщения</label>
				<textarea 
					id="form-question" 
					minlength="0"
					maxlength="100" 
					data-textarea 
					placeholder="Текст сообщения" 
					class="form-field" 
					rows="5" 
					required
				></textarea>
				<span class="form-field__error" data-field-error></span>
				<span class="form-field__description" data-textarea-counter>1/100</span>
			</div>
			<div class="form__row form__row_submit">
				<Button type="submit" data-animate>Отправить</Button>
				<p role="alert" aria-live="polite" data-form-msg class="form_submit-message"></p>
			</div>
		</div>
	</form>
</div>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		sendContactForm();
		countTextaria();
	});

	function sendContactForm() {
		const formEl = document.querySelector("[data-contact-form]");
		const actionMessage = document.querySelector('[data-form-msg]');
		const errorSvg = `
			<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
				<g clip-path="url(#clip0_7_1104)">
					<path d="M7.99967 14.6666C11.6816 14.6666 14.6663 11.6818 14.6663 7.99992C14.6663 4.31802 11.6816 1.33325 7.99967 1.33325C4.31778 1.33325 1.33301 4.31802 1.33301 7.99992C1.33301 11.6818 4.31778 14.6666 7.99967 14.6666Z" stroke="#FC1447" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M10 6L6 10" stroke="#FC1447" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M6 6L10 10" stroke="#FC1447" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
				</g>
				<defs>
					<clipPath id="clip0_7_1104">
						<rect width="16" height="16" fill="white"/>
					</clipPath>
				</defs>
			</svg>`;

		formEl?.addEventListener('submit', (e) => {
			e.preventDefault();

			formEl.querySelectorAll(".form-field").forEach((element) => {
				const errorMsgEl = element?.closest('div')?.querySelector('[data-field-error]');

				if(!element.checkValidity()) {
					element.classList.add('form-field_error');
					errorMsgEl.innerHTML = `${errorSvg} ${element?.validationMessage}`;
					return;
				} 

				element.classList.remove('form-field_error');
				errorMsgEl.innerHTML = '';
			});

			if (!formEl.checkValidity()) {
				// formEl.reportValidity();

				return;
			}

			const url = formEl?.action;
			fetch(url, {
				method:'post', 
				body: new FormData(formEl)
			})
			.then((response) => {
				if (response.status === 200) {
					actionMessage.innerHTML = `
						✅ Отправлено.
					`;
				} else {
					actionMessage.innerHTML = `
						❗ При отправке возникли проблемы.
					`;
				}
			})
			.catch(() => {
				actionMessage.innerHTML = `
					❗ При отправке возникли проблемы.<br>
					Попробуйте позже
				`;
			});	

		});
	}

	function countTextaria() {
		const textarea = document.querySelector("[data-textarea]");
		const counterEl = document.querySelector("[data-textarea-counter]");

		textarea?.addEventListener("input", (e) => {
			render(e);
		});
		textarea?.addEventListener("change", (e) => {
			render(e);
		});

		function render(event) {
			const target = event.currentTarget;
			const maxLength = target.getAttribute("maxlength");
			const currentLength = target.value.length;

			counterEl.innerHTML = `${currentLength}/${maxLength}`;
		}
	}
</script>
<style lang="scss">
	.title {
		text-align: center;
		font-size: calc(var(--adaptive-pixel) * 80);
		line-height: 1.1;
		margin-bottom: var(--size-15);
	}
	.subtitle {
		text-align: center;
		margin-bottom: var(--size-60);
	}
	.form {
		margin: var(--size-60) auto var(--size-120);
		max-width: calc(var(--adaptive-pixel) * 706);
	}
	.form_submit-message {
		text-align: center;
		margin: var(--size-30) 0;
		&:empty {
			display: none;
		}
	}
	.form__layout {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
	}
	.form__row {
		margin-bottom: calc(var(--adaptive-pixel) * 20);
		width: 100%;
	}
	.form__row_half {
		width: 48%;
	}
	.form__row_submit {
		margin-top: var(--size-30);
		text-align: center;
	}

	.form-field {
		border: none;
		background: #25282B;
		color: var(--text-color);
		font-weight: 400;
		font-size: calc(var(--adaptive-pixel) * 16);
		line-height: 1.5;
		font-family: inherit;
		padding: calc(var(--adaptive-pixel) * 16) calc(var(--adaptive-pixel) * 20);
		width: 100%;
		&:hover {
			outline: 1px solid #E8E6F8;
		}
		&:focus {
			outline: 1px solid #605DEC;
		}
		// &:not(:focus):invalid {
		// 	outline: 1px solid #FFEAC1;
		// }
		&_error {
			outline: 1px solid #FFD8D8;
		}
		&::placeholder {
			color: var(--text-color);
		}

	}
	textarea.form-field {
		resize: vertical;
		min-height: calc(var(--adaptive-pixel) * 140);
		max-height: calc(var(--adaptive-pixel) * 300);
	}
	.form-field__error,
	.form-field__description {
		display: flex;
		align-items: baseline;
    	gap: 0.3em;
		color: #AAAAAA;
		font-size: var(--extra-small-font-size);
		margin-top: var(--size-8);
		&:empty {
			display: none;
		}
		& :global(svg) {
			min-width: calc(var(--adaptive-pixel) * 16);
		}
	}
	@media screen and (width < 1024px) {
		.title {
			font-size: var(--heading-1);
			margin-top: var(--size-60);
			margin-bottom: var(--size-30);
			line-height: .72;
		}
		.subtitle {
			margin-bottom: var(--size-30);
		}
		.form {
			margin: var(--size-30) auto var(--size-90);
		}
		.form__layout {
			flex-direction: column;
		}
		.form__row {
			margin-bottom: var(--size-15);
		}
		.form__row_half {
			width: 100%;
		}
		.form__row_submit {
			margin-top: var(--size-15);
		}

	}
</style>
